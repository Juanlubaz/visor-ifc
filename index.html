<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visor IFC - Juanlubaz</title>
  <style>
    :root { --ui-bg: rgba(0,0,0,0.6); --ui-fg: #fff; }
    html,body { height:100%; margin:0; font-family:Arial,Helvetica,sans-serif; background:#0b0b0b; color:var(--ui-fg); }
    #viewer { width:100%; height:100vh; display:block; }
    #ui {
      position:fixed; left:12px; top:12px; z-index:20;
      background:var(--ui-bg); color:var(--ui-fg); padding:8px 10px; border-radius:8px;
      font-size:13px; backdrop-filter: blur(6px);
    }
    #status { font-size:12px; opacity:0.95; }
    #loaderBar { width:180px; height:6px; background:rgba(255,255,255,0.08); margin-top:8px; border-radius:4px; overflow:hidden; }
    #loaderFill { width:0%; height:100%; background:rgba(255,255,255,0.28); transition:width 180ms linear; }
    a.small { color: #cfe; text-decoration:none; margin-left:8px; font-size:12px; }
    #help { position:fixed; right:12px; bottom:12px; background:var(--ui-bg); padding:8px 10px; border-radius:8px; font-size:13px; }
  </style>
</head>
<body>
  <canvas id="viewer"></canvas>

  <div id="ui">
    <div id="status">Cargando visor…</div>
    <div id="loaderBar"><div id="loaderFill"></div></div>
    <div style="margin-top:6px;font-size:12px;opacity:0.9">Archivo: <span id="fname">—</span></div>
  </div>

  <div id="help">Usa dos dedos (móvil) o ratón: girar / desplazar / zoom</div>

  <script type="module">
    import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.module.js";
    import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.150.0/examples/jsm/controls/OrbitControls.js";
    import { IFCLoader } from "https://cdn.jsdelivr.net/npm/three@0.150.0/examples/jsm/loaders/IFCLoader.js";

    // --- Utils ---
    const $ = id => document.getElementById(id);
    function getParam(name) {
      const u = new URL(location.href);
      return u.searchParams.get(name);
    }
    function setStatus(text) { $("status").textContent = text; }

    // --- Scene / Renderer / Camera ---
    const canvas = $("viewer");
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: false });
    renderer.setPixelRatio(window.devicePixelRatio || 1);
    renderer.setSize(window.innerWidth, window.innerHeight, false);
    renderer.outputEncoding = THREE.sRGBEncoding;

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0b0b0b);

    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(10, 10, 12);

    // Lights
    const ambient = new THREE.AmbientLight(0xffffff, 0.9);
    scene.add(ambient);
    const dir = new THREE.DirectionalLight(0xffffff, 0.6);
    dir.position.set(10, 20, 10);
    scene.add(dir);

    // Controls
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.07;
    controls.screenSpacePanning = false;
    controls.minDistance = 0.1;
    controls.maxDistance = 500;

    // IFC Loader
    const loader = new IFCLoader();
    // Web-IFC wasm (ruta pública CDN)
    loader.ifcManager.setWasmPath("https://cdn.jsdelivr.net/npm/web-ifc@0.0.46/");

    let currentModel = null;

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight, false);
    });

    // --- Loading UI helpers ---
    function setProgress(pct) {
      const w = Math.max(0, Math.min(100, Math.round(pct)));
      $("loaderFill").style.width = w + "%";
    }

    // --- Load model from URL param ---
    const modeloParam = getParam("modelo") || "TSP3-ST-004-PCK001-S.ifc";
    $("fname").textContent = modeloParam;

    // Security: prevent directory traversal
    if (modeloParam.includes("..")) {
      setStatus("Nombre de archivo inválido");
      console.error("Nombre de archivo inválido:", modeloParam);
      throw new Error("Invalid filename");
    }

    async function loadIfcModel(filename) {
      setStatus("Cargando archivo: " + filename);
      setProgress(5);

      // Remove previous model
      if (currentModel) {
        scene.remove(currentModel);
        currentModel.traverse(c => { if (c.geometry) c.geometry.dispose(); if (c.material) { if (Array.isArray(c.material)) c.material.forEach(m => m.dispose()); else c.material.dispose(); } });
        currentModel = null;
      }

      // loader.load supports same-origin files (GitHub Pages serves them from same repo)
      loader.load(
        filename,
        (ifcModel) => {
          currentModel = ifcModel;
          scene.add(ifcModel);

          // Center & scale
          const box = new THREE.Box3().setFromObject(ifcModel);
          const center = new THREE.Vector3();
          box.getCenter(center);
          ifcModel.position.x += (ifcModel.position.x - center.x);
          ifcModel.position.y += (ifcModel.position.y - center.y);
          ifcModel.position.z += (ifcModel.position.z - center.z);

          const size = box.getSize(new THREE.Vector3()).length();
          const dist = size * 1.8;
          camera.position.set(dist, dist, dist);
          camera.lookAt(center);
          controls.target.copy(center);
          controls.update();

          setProgress(100);
          setStatus("Modelo cargado correctamente");
        },
        (xhr) => {
          // Progress: sometimes xhr.total is unknown
          let pct = 0;
          try { pct = (xhr.loaded / (xhr.total || (xhr.loaded + 1))) * 90; } catch(e) { pct = 50; }
          setProgress(pct);
        },
        (err) => {
          console.error("Error cargando IFC:", err);
          setStatus("Error: no se pudo cargar el IFC (comprueba nombre y permisos).");
          setProgress(0);
        }
      );
    }

    // Start
    loadIfcModel(modeloParam);
  </script>
</body>
</html>
